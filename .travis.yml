env:
  global:
    secure: vLhIQkEurHHN/csZ2rWFoznaDnOfmG+RNLq1Tk4Q3REf1ECpPbSLRflaeVH9rKzjZtLGmPLD1XxvWYrB9yptUvHQR5t0EKzLu3gItqySL19Rd4BJUuaQjvWOBXGPDHLbXJgZmgvfpzvOLtX01e89NjeuITOlvUbqd2DIiL2aQKYyWmnw0BYRsQsej8Q/F/CQRky9+JVZmOu0rqeQhclweUyDKGFDJ9e8IlsUEOMfx1q3IET4Rgqkb7wWFLLXEPxDaYsAsxNJCQpb4mqaYmOXLN9r88ajrqt1WEMqzzsKraL3NI3IchgNLLCRC35KVr24SH+nbQMKV1twsT8cRxfOKc0IQfMU59EINZ5XIHG8MWp3bCPJabjyxhJgbcF5eEcvgeevmi2QSa0fTk1Uc3S4d1bLQe9bch3iWN81BCpDg8XdGxcczWOmpDc4I2FmorNPfBBn6Z1oTNVpoaTIpwZ3lIpk9/STE77uCueHpkTzCvo9ugyHnRrjdcLwTqTggWsm2JW9H+CPnIsofg2rlnZIVY4xrikf6G78SFbeg6vIL4JnvVaS+wDkgXLKlS2RZJx1DiZQAlbZXciRzoHtaRQhbOxpZLMSmdOXk7NHP1AdLOtSvJE5cm5KhUAMUt7V3ARmOtbbOoMkeTn1dyIzE6HbTVof+tuOtgAWpjQwpnCGKNM=

stages:
- build
- before_deploy
- deploy
jobs:
  include:
  - stage: build
    language: android
    dist: trusty
    jdk:
    - openjdk8
    android:
      components:
      - build-tools-29.0.2
      - platform-tools
      - android-29
    before_install:
    - nvm install 12
    install:
    - npm install -g @quasar/cli
    - npm install -g cordova
    script:
    - openssl aes-256-cbc -k 'CWvQqwwPWYDcsDRjeKaj' -in googleplay.keystore.enc -out googleplay.keystore -d
    - mvn versions:set -DnewVersion=$TRAVIS_BRANCH
    - mvn versions:commit
    - mvn clean
    - mvn install -P prod
    - mkdir push
    - cp ./backend/target/*.jar ./push
    - jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore googleplay.keystore
      -storepass $GOOGLEPLAY_KEYSTORE_PASSPHRASE ./frontend/src-cordova/platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk
      googleplay-key
    - "${ANDROID_HOME}/build-tools/29.0.2/zipalign -v 4 ./frontend/src-cordova/platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk
      ./push/android-app.apk"
    deploy:
    - provider: releases
      api_key: "$GITHUB_TOKEN"
      file:
      - "./push/*"
      file_glob: true
      skip_cleanup: true
      on:
        tags: true
      overwrite: true
    workspaces:
      create:
        name: target
        paths:
        - "./backend/target/"
        - "./push/"
  - stage: before_deploy
    language: sh
    services:
    - docker
    before_deploy:
    - docker run --rm --privileged multiarch/qemu-user-static:register --reset
    - docker build -t alex9849/pi-cocktailmaker:$TRAVIS_TAG -f ./docker/Dockerfile
      ./
    - docker tag alex9849/pi-cocktailmaker:$TRAVIS_TAG alex9849/pi-cocktailmaker:latest
    - docker build -t alex9849/pi-cocktailmaker:$TRAVIS_TAG-pi -f ./docker/DockerfilePi
      ./
    - docker tag alex9849/pi-cocktailmaker:$TRAVIS_TAG-pi alex9849/pi-cocktailmaker:latest-pi
    workspaces:
      use: target
    deploy:
      provider: script
      script: bash ./.travis/docker_deploy.sh
      on:
        tags: true
        overwrite: true
