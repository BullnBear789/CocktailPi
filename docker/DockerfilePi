FROM balenalib/raspberry-pi-debian:buster
ENV DOCKERIZE_VERSION v0.6.1
RUN apt update
RUN apt -y full-upgrade
RUN apt -yq install python python3-pip pigpio python-pigpio python3-pigpio wget openssl
RUN pip3 install --upgrade setuptools
RUN pip3 install RPI.GPIO gpiozero adafruit-blinka adafruit-io --quiet
COPY docker/install-java.sh /install-java.sh
RUN chmod u+x /install-java.sh && /install-java.sh
RUN wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-armhf-$DOCKERIZE_VERSION.tar.gz \
    && tar -C /usr/local/bin -xzvf dockerize-linux-armhf-$DOCKERIZE_VERSION.tar.gz \
    && rm dockerize-linux-armhf-$DOCKERIZE_VERSION.tar.gz

EXPOSE 8080/tcp
ENV LOG_LEVEL=debug
ENV TZ=Europe/Berlin
ENV DEMOMODE=false
ENV DB_HOST=db
ENV DB_PORT=5432

COPY backend/target/server.jar /app.jar

CMD ["sh", "-c", "dockerize -wait tcp://${DB_HOST}:${DB_PORT} -timeout 300s -wait-retry-interval 30s java -jar /app.jar"]
